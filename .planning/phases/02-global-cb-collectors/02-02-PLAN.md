---
phase: 02-global-cb-collectors
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/liquidity/collectors/boc.py, pyproject.toml, tests/integration/test_global_cb_collectors.py]
autonomous: true
---

<objective>
Create Bank of Canada collector using the Valet API.

Purpose: BoC has an excellent free REST API (Valet) with no authentication required. This collector provides Canadian central bank balance sheet data.

Output: BOCCollector class that fetches BoC balance sheet totals via pyvalet, registered with collector registry.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-global-cb-collectors/02-RESEARCH.md

# Prior work
@.planning/phases/01-foundation-core-data/01-02-SUMMARY.md

# Source files - patterns to follow
@src/liquidity/collectors/fred.py
@src/liquidity/collectors/base.py
@src/liquidity/collectors/registry.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pyvalet dependency</name>
  <files>pyproject.toml</files>
  <action>
Add pyvalet to dependencies in pyproject.toml:

```toml
dependencies = [
    ...
    # Phase 2: Global CB collectors
    "pyvalet>=0.2.0",
]
```

Run `uv sync` to install.

Note: pyvalet is the official Bank of Canada Python wrapper for their Valet API.
  </action>
  <verify>uv run python -c "from pyvalet import ValetInterpreter; print('pyvalet imported')"</verify>
  <done>pyvalet installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Create BOCCollector class</name>
  <files>src/liquidity/collectors/boc.py</files>
  <action>
Create BOCCollector following the same pattern as FredCollector:

```python
"""Bank of Canada collector using Valet API.

Fetches BoC balance sheet data via the official Valet API (no auth required).
"""

import asyncio
import logging
from datetime import UTC, datetime, timedelta

import pandas as pd
from pyvalet import ValetInterpreter

from liquidity.collectors.base import BaseCollector, CollectorFetchError
from liquidity.collectors.registry import registry

logger = logging.getLogger(__name__)

# BoC series mapping - DISCOVERED via Valet API
# Group: B2_WEEKLY - Bank of Canada assets and liabilities: Weekly
SERIES_MAP: dict[str, str] = {
    "boc_total_assets": "V36610",  # Total assets - Weekly, Millions CAD
    "boc_total_liabilities": "V36624",  # Total liabilities and equity
}

UNIT_MAP: dict[str, str] = {
    "V36610": "millions_cad",  # Weekly Wednesday values
    "V36624": "millions_cad",
}


class BOCCollector(BaseCollector[pd.DataFrame]):
    """Bank of Canada collector using Valet API."""

    def __init__(self, name: str = "boc", **kwargs):
        super().__init__(name=name, **kwargs)
        self._client = ValetInterpreter()

    async def collect(
        self,
        series_id: str | None = None,
        start_date: datetime | None = None,
        end_date: datetime | None = None,
    ) -> pd.DataFrame:
        """Collect BoC data via Valet API."""
        async def _fetch():
            return await asyncio.to_thread(
                self._fetch_sync, series_id, start_date, end_date
            )
        return await self.fetch_with_retry(_fetch)

    def _fetch_sync(
        self,
        series_id: str | None,
        start_date: datetime | None,
        end_date: datetime | None,
    ) -> pd.DataFrame:
        """Synchronous fetch using pyvalet."""
        # Implementation TBD - need to explore available series
        ...

    def discover_series(self) -> pd.DataFrame:
        """Discover available BoC series."""
        return self._client.list_series()  # pyvalet 1.1.1 API


registry.register("boc", BOCCollector)
```

Key implementation notes:
1. Use ValetInterpreter() - no auth needed
2. First explore available series with `get_all_series()` to find balance sheet totals
3. Wrap sync pyvalet calls with `asyncio.to_thread()`
4. Return standardized DataFrame with timestamp, series_id, source, value, unit columns
5. Register with collector registry
  </action>
  <verify>uv run python -c "from liquidity.collectors.boc import BOCCollector; c = BOCCollector(); print(c)"</verify>
  <done>BOCCollector class exists, is importable, and registered</done>
</task>

<task type="auto">
  <name>Task 3: Implement _fetch_sync and add integration tests</name>
  <files>src/liquidity/collectors/boc.py, tests/integration/test_global_cb_collectors.py</files>
  <action>
Series already discovered:
- **V36610**: Total Assets (Weekly Wednesday, Millions CAD)
- **V36624**: Total Liabilities and Equity

Implement _fetch_sync() using direct Valet API:
```python
def _fetch_sync(self, series_id: str | None, start_date, end_date) -> pd.DataFrame:
    # Use direct HTTP to Valet (pyvalet's get_observations is unreliable)
    url = f"https://www.bankofcanada.ca/valet/observations/{series_id or 'V36610'}/json"
    # Parse and normalize to DataFrame
```

BoC API endpoint verified working:
- URL: `https://www.bankofcanada.ca/valet/observations/V36610/json`
- Latest value: ~320,000 million CAD (~320 billion CAD)
- Weekly Wednesday data

Add integration test:
- Verify V36610 fetch returns data
- Verify values in reasonable range (200-500 billion CAD)
- Verify timestamp and unit columns
  </action>
  <verify>uv run pytest tests/integration/test_global_cb_collectors.py::test_boc_collector -v --tb=short</verify>
  <done>BoC collector implemented with V36610, tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv run ruff check src/liquidity/collectors/boc.py` passes
- [ ] `uv run mypy src/liquidity/collectors/boc.py` passes
- [ ] `uv run pytest tests/integration/test_global_cb_collectors.py -v -k boc` passes
- [ ] BOCCollector successfully fetches BoC balance sheet data
</verification>

<success_criteria>

- pyvalet dependency added and working
- BOCCollector class follows BaseCollector pattern
- BoC balance sheet series identified and fetchable
- Data normalized to standard format with CAD units
- Integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-global-cb-collectors/02-02-SUMMARY.md`
</output>
