---
phase: 02-global-cb-collectors
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [src/liquidity/collectors/snb.py, pyproject.toml, tests/integration/test_global_cb_collectors.py]
autonomous: true
---

<objective>
Create Swiss National Bank collector.

Purpose: SNB publishes balance sheet data via their data portal. Primary approach uses Nasdaq Data Link (formerly Quandl) SNB/SNBBIPO dataset. Fallback is direct CSV download from SNB portal.

Output: SNBCollector class that fetches SNB balance sheet totals, registered with collector registry.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-global-cb-collectors/02-RESEARCH.md

# Prior work
@.planning/phases/01-foundation-core-data/01-02-SUMMARY.md

# Source files - patterns to follow
@src/liquidity/collectors/fred.py
@src/liquidity/collectors/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SNBCollector with direct CSV approach</name>
  <files>src/liquidity/collectors/snb.py</files>
  <action>
Create SNBCollector that fetches from SNB data portal:

```python
"""Swiss National Bank collector.

SNB publishes balance sheet data at https://data.snb.ch/en
Uses direct CSV download (more reliable than Nasdaq Data Link for free tier).
"""

import asyncio
import io
import logging
from datetime import datetime

import httpx
import pandas as pd

from liquidity.collectors.base import BaseCollector, CollectorFetchError
from liquidity.collectors.registry import registry

logger = logging.getLogger(__name__)

# SNB data portal endpoints
# Balance sheet items: https://data.snb.ch/en/publishingSet/C
SNB_DATA_URL = "https://data.snb.ch/api/cube/snbbipo/data/csv/en"

UNIT_MAP: dict[str, str] = {
    "SNB_TOTAL_ASSETS": "millions_chf",
}


class SNBCollector(BaseCollector[pd.DataFrame]):
    """Swiss National Bank collector via data portal CSV."""

    def __init__(self, name: str = "snb", **kwargs):
        super().__init__(name=name, **kwargs)

    async def collect(
        self,
        start_date: datetime | None = None,
        end_date: datetime | None = None,
    ) -> pd.DataFrame:
        """Collect SNB balance sheet data."""
        async def _fetch():
            async with httpx.AsyncClient(timeout=30.0) as client:
                response = await client.get(SNB_DATA_URL)
                response.raise_for_status()
                return self._parse_csv(response.text)

        return await self.fetch_with_retry(_fetch)

    def _parse_csv(self, csv_text: str) -> pd.DataFrame:
        """Parse SNB CSV to standard format."""
        df = pd.read_csv(io.StringIO(csv_text))

        # SNB CSV structure needs exploration
        # Look for "Total" row in balance sheet items
        # Filter by date range if provided

        # Normalize to standard format
        result = pd.DataFrame({
            "timestamp": ...,
            "series_id": "SNB_TOTAL_ASSETS",
            "source": "snb",
            "value": ...,
            "unit": "millions_chf",
        })

        return result


registry.register("snb", SNBCollector)
```

Key implementation notes:
1. SNB data portal at data.snb.ch provides CSV API
2. No authentication required
3. Balance sheet items dataset: snbbipo
4. Need to explore CSV structure to find total assets column/row
5. Data in millions CHF
  </action>
  <verify>uv run python -c "from liquidity.collectors.snb import SNBCollector; c = SNBCollector(); print(c)"</verify>
  <done>SNBCollector class exists with CSV download implementation</done>
</task>

<task type="auto">
  <name>Task 2: Explore and implement SNB data parsing</name>
  <files>src/liquidity/collectors/snb.py</files>
  <action>
1. Fetch SNB CSV and examine structure:
   - What columns exist?
   - How is total assets represented?
   - What is the date format?

2. Implement _parse_csv() to:
   - Parse the CSV correctly
   - Extract total assets row/column
   - Convert dates to timestamp
   - Handle any SNB-specific formatting

3. If SNB data portal doesn't have clean total assets:
   - Try Nasdaq Data Link free tier: `pip install nasdaq-data-link`
   - Query: `nasdaqdatalink.get("SNB/SNBBIPO")`
   - Document which approach works

Expected data:
- Total Assets ~866 billion CHF (from research)
- Monthly frequency
- Millions CHF unit
  </action>
  <verify>Manually test the CSV endpoint and parsing logic</verify>
  <done>SNB CSV parsing implemented and working</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for SNBCollector</name>
  <files>tests/integration/test_global_cb_collectors.py</files>
  <action>
Add integration tests for SNBCollector:

```python
class TestSNBCollector:
    """Tests for Swiss National Bank collector."""

    @pytest.mark.integration
    async def test_snb_collect_balance_sheet(self):
        """Test fetching SNB balance sheet data."""
        collector = SNBCollector()
        df = await collector.collect()

        assert not df.empty
        assert "timestamp" in df.columns
        assert "value" in df.columns
        assert df["source"].iloc[0] == "snb"

    @pytest.mark.integration
    async def test_snb_data_reasonable_range(self):
        """Test SNB data is in reasonable range."""
        collector = SNBCollector()
        df = await collector.collect()

        # SNB total assets should be 500-1500 billion CHF range
        # In millions: 500,000 - 1,500,000
        latest = df["value"].iloc[-1]
        assert 500_000 < latest < 1_500_000, f"SNB total assets {latest} out of expected range"
```

Tests should:
1. Verify CSV download works
2. Verify total assets data exists
3. Verify values are in reasonable range (sanity check)
4. Handle network errors gracefully
  </action>
  <verify>uv run pytest tests/integration/test_global_cb_collectors.py::TestSNBCollector -v --tb=short</verify>
  <done>Integration tests exist and pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv run ruff check src/liquidity/collectors/snb.py` passes
- [ ] `uv run mypy src/liquidity/collectors/snb.py` passes
- [ ] `uv run pytest tests/integration/test_global_cb_collectors.py -v -k snb` passes
- [ ] SNBCollector successfully fetches SNB balance sheet data
</verification>

<success_criteria>

- SNBCollector class follows BaseCollector pattern
- SNB data portal CSV or Nasdaq Data Link works
- Data normalized to standard format with CHF units
- Values in reasonable range for SNB total assets
- Integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-global-cb-collectors/02-04-SUMMARY.md`
</output>
